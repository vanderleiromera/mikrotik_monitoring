onsuccess: next_stage
name: local/mikrotik7-logs
description: "Universal Mikrotik parser - Compatible with official scenarios"
filter: "evt.Parsed.program == 'Core' || evt.Line.Src contains 'mikrotik' || evt.Line.Src contains '10.11.13.1'"
debug: false
nodes:
  # 1. SSH/Account Login Failures - COMPATÍVEL COM CENÁRIO OFICIAL!
  - grok:
      pattern: 'login\s+failure for user %{DATA:invalid_user} from %{IPORHOST:source_ip} via %{WORD:service}'
      apply_on: message
    statics:
      - meta: service
        expression: evt.Parsed.service
      - meta: log_type
        value: mikrotik_failed_auth  # ← NOME EXATO QUE O CENÁRIO OFICIAL ESPERA!
      - meta: source_ip
        expression: evt.Parsed.source_ip
      - meta: username
        expression: evt.Parsed.invalid_user  # ← Use 'invalid_user' como o oficial

  # 2. Successful Logins
  - grok:
      pattern: 'user\s+%{USERNAME:username} logged in from %{IPORHOST:source_ip} via %{WORD:service}'
      apply_on: message
    statics:
      - meta: service
        expression: evt.Parsed.service
      - meta: log_type
        value: login_success
      - meta: source_ip
        expression: evt.Parsed.source_ip
      - meta: username
        expression: evt.Parsed.username

  # 3. Firewall Drops (a1ad)
  - grok:
      pattern: '%{DATA:tag} input: in:%{DATA:if_in} out:%{DATA:if_out}, connection-state:%{DATA:connection_state} src-mac %{MAC:src_mac}, proto %{WORD:proto}.*, %{IP:source_ip}:%{INT:src_port}->%{IP:dst_ip}:%{INT:dst_port}, len %{INT:length}'
      apply_on: message
    statics:
      - meta: service
        value: tcp_udp
      - meta: log_type
        value: mikrotik_drop
      - meta: source_ip
        expression: evt.Parsed.source_ip
      - meta: dst_ip
        expression: evt.Parsed.dst_ip
      - meta: dst_port
        expression: evt.Parsed.dst_port
      - meta: protocol
        expression: evt.Parsed.proto

  # 4. Firewall Drops (formato simplificado)
  - grok:
      pattern: 'input:.*proto %{WORD:proto}.*%{IP:source_ip}:%{INT:src_port}->%{IP:dst_ip}:%{INT:dst_port}'
      apply_on: message
    statics:
      - meta: service
        value: firewall
      - meta: log_type
        value: mikrotik_drop
      - meta: source_ip
        expression: evt.Parsed.source_ip
      - meta: dst_ip
        expression: evt.Parsed.dst_ip
      - meta: dst_port
        expression: evt.Parsed.dst_port
      - meta: protocol
        expression: evt.Parsed.proto

  # 5. System Events
  - grok:
      pattern: 'system.*%{GREEDYDATA:event}'
      apply_on: message
    statics:
      - meta: service
        value: system
      - meta: log_type
        value: system_event

  # 6. Configuration Changes
  - grok:
      pattern: '%{DATA:action} by %{DATA:method}:%{USERNAME:user}@%{IPORHOST:source_ip}'
      apply_on: message
    statics:
      - meta: service
        value: config
      - meta: log_type
        value: config_change
      - meta: source_ip
        expression: evt.Parsed.source_ip
      - meta: username
        expression: evt.Parsed.user
        
  # 7. SCAN IPv4 (sem colchetes)
  - grok:
      pattern: 'SCAN-IPv4.*proto %{WORD:proto}.*%{IPV4:source_ip}:%{INT:src_port}->%{IPV4:dst_ip}:%{INT:dst_port}'
      apply_on: message
    statics:
      - meta: service
        value: firewall
      - meta: log_type
        value: mikrotik_drop
      - meta: source_ip
        expression: evt.Parsed.source_ip
      - meta: dst_ip
        expression: evt.Parsed.dst_ip
      - meta: dst_port
        expression: evt.Parsed.dst_port
      - meta: protocol
        expression: evt.Parsed.proto

  # 8. SCAN IPv6 (COM colchetes!)
  - grok:
      pattern: 'SCAN-IPv6.*proto %{WORD:proto}.*\[%{DATA:source_ip}\]:%{INT:src_port}->\[%{DATA:dst_ip}\]:%{INT:dst_port}'
      apply_on: message
    statics:
      - meta: service
        value: firewall
      - meta: log_type
        value: mikrotik_drop
      - meta: source_ip
        expression: evt.Parsed.source_ip
      - meta: dst_ip
        expression: evt.Parsed.dst_ip
      - meta: dst_port
        expression: evt.Parsed.dst_port
      - meta: protocol
        expression: evt.Parsed.proto    

statics:
  - target: evt.StrTime
    expression: evt.Parsed.timestamp
  - meta: source_ip
    expression: evt.Parsed.source_ip    



